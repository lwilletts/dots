#!/bin/sh
#
# snip

generateInfo() {
    trackOld="$trackNew"
    printf '%s\n' "$trackOld" > "$HOME/.playingnow"

    path="$(mpvc -f "%path%")"
    ffmpeg -hide_banner -loglevel panic -y -i "$path" "$HOME/.cover.png" || {
        coverpath="$(printf '%s\n' "$path" | rev | cut -d/ -f 2- | rev)"
        test -e "$coverpath/?over.*" && {
            cp "$coverpath/?over.*" "$HOME/.cover.png"
        }
    }
}

main() {
    trackOld=""
    trackNew="$(mpvc -f "%artist% - %title%                   ")"
    test "$trackNew" = "No files added to /tmp/mpvsocket." && exit 1
    generateInfo

    while :; do
        test "$trackNew" != "$trackOld" && generateInfo

        trackNew="$(mpvc -f "%artist% - %title%                   ")"
        test "$trackNew" = "No files added to /tmp/mpvsocket." && exit 1
        sleep 1
    done
}

main
