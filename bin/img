#!/bin/sh

validateDeps() {
    test -x /usr/lib/w3m/w3mimgdisplay && {
        W3MCMD="/usr/lib/w3m/w3mimgdisplay"
        return
    }

    printf '%s\n' "install w3m numpty"

    exit 1
}

img() {
    WH=$(printf "5;$FILENAME" | $W3MCMD)
    W=$(printf '%s\n' "$WH" | cut -d\  -f 1)
    H=$(printf '%s\n' "$WH" | cut -d\  -f 2)

    unset -v WH

    FW=5
    FH=10
    LINES=$(tput lines)
    COLUMNS=$(tput cols)

    MW=$((FW * $COLUMNS))
    MH=$((FH * $(($LINES - 2))))

    test $W -gt $MW && {
        H=$(($H * $MW / $W))
        W=$MW
    }

    test $H -gt $MH && {
        W=$(($W * $MH / $H))
        H=$MH
    }

    tput clear
    tput cup $((H/FH)) 0

    printf "0;1;0;0;$W;$H;;;;;$FILENAME\n4;\n3;" | $W3MCMD
    printf '%s\n'
}

main() {
    validateDeps

    test -e "$@" && FILENAME="$@" || exit 1
    mpvcmd="mpv --really-quiet --loop-file"

    case "$FILENAME" in
        *.gif)
            $mpvcmd $FILENAME
            ;;
        *.webm)
            $mpvcmd $FILENAME
            ;;
        *)
            img
            ;;
    esac
}

main "$@"
