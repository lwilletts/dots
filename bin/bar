#!/bin/sh

ACTIVE="%{F#D7D7D7}"
INACTIVE="%{F#737373}"

gpu() {
    sensorOut="$(sensors)"
    VOLT=$(printf '%s\n' "$sensorOut"  | awk '/vddgfx/ {print $2,$3}')
    TEMP=$(printf '%s\n' "$sensorOut"  | awk '/temp1/ && $3 == "(crit" {print $2}' | cut -c 2-)
    POWER=$(printf '%s\n' "$sensorOut" | awk '/power1/ {print $2,$3}')
    SPEED=$(printf '%s\n' "$sensorOut" | awk '/fan1/ {print $2,$3}')

    printf '%s\n' "VEGA20: $VOLT / $TEMP / $POWER / $SPEED"
}

runTaskbar() {
    while :; do
        case "$(hostname)" in
            "fyriousa")
                menu="drun"
                clock=$(date '+%d %b %H:%M')
                calender="urxvtc -e sh -c '3cal'"

                cava="urxvtc -e sh -c 'cava'"

                mpvc -q
                test $? != 2 && {
                    mus="$(mpvc -f '%artist% / %title% / %remaining%')"
                    test "$mus" = "No files added to /tmp/mpvsocket." && mus=""
                }

                vol="urxvtc -e sh -c 'pulsemixer'"

                buf=""
                buf="${buf} %{l}"
                buf="${buf} %{A:${menu}:}▷                                                       %{A}"
                buf="${buf} %{r}"
                buf="${buf} %{A:${cava}:} ${mus} %{A}"
                buf="${buf} $(gpu)"
                buf="${buf} %{A:${calender}:} ${clock} %{A}"
                buf="${buf} %{A:${vol}:}♪  %{A}"
                ;;
            "inferno")
                menu="drun"
                clock=$(date '+%d %b %H:%M')
                calender="urxvtc -e sh -c '3cal'"

                cava="urxvtc -e sh -c 'cava'"

                mpvc -q
                test $? != 2 && {
                    mus="$(mpvc -f '%artist% / %title% / %remaining%')"
                    test "$mus" = "No files added to /tmp/mpvsocket." && mus=""
                }

                vol="urxvtc -e sh -c 'pulsemixer'"

                buf=""
                buf="${buf} %{l}"
                buf="${buf} %{A:${menu}:}▷                                                       %{A}"
                buf="${buf} %{r}"
                buf="${buf} %{A:${cava}:} ${mus} %{A}"
                buf="${buf} %{A:${calender}:} ${clock} %{A}"
                buf="${buf} %{A:${vol}:}♪  %{A}"
                ;;
        esac

        printf '%s\n' "$buf"
        sleep 1
    done
}

BW="$(grep borderwidth $HOME/.cwmrc | cut -d\  -f 2)"

# set bar variables and launch backbar
barx=$((70 - BW))
bary=$((10 - BW))
barw=$((900 + BW))
barh=$((20 + BW*2))
bar_bg='#404552'

backbar $barx $bary $barw $barh $bar_bg &
sleep 0.2

barx=$((barx + BW))
bary=$((bary + BW))
barw=$((barw - BW*2))
barh=$((barh - BW*2))
bar_bg='#040404'
bar_fg='#D7D7D7'
bar_font=$(awk '/lemon/ {print $3}' < ~/.Xresources | head -n 1 | cut -d',' -f 1)

runTaskbar | lemonbar -d -g ${barw}x${barh}+${barx}+${bary} -B${bar_bg} \
                      -F${bar_fg} -f${bar_font} -n "infobar" | /bin/sh &
