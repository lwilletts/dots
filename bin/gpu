#!/bin/sh
#
# gpu

# find correct card
i=0
while :; do
    radeonPCI="/sys/class/drm/card$i/device"
    uevent="$radeonPCI/uevent"

    while :; do
        test -e "$uevent" && break
    done

    driver="$(awk -F '=' '/DRIVER/ {print $2}' "$uevent")"
    test "$driver" = "amdgpu" && break

    i="$((i + 1))"
    test "$i" -eq 4 && i=0
done

sclk="$radeonPCI/pp_dpm_sclk"
test -z "$sclk" && exit 1

sensorOut="$(sensors)"
VOLT="$(cat "$radeonPCI/hwmon/hwmon2/in0_input") mv"
EDGE=$(printf '%s\n' "$sensorOut" | awk '/edge/ && $3 == "(crit" {print $2}' | cut -c 2-)
JUNC=$(printf '%s\n' "$sensorOut" | awk '/junction/ && $3 == "(crit" {print $2}' | cut -c 2-)
POWR=$(printf '%s\n' "$sensorOut" | awk '/power1/ {print $2,$3}')
FANS=$(printf '%s\n' "$sensorOut" | awk '/fan1/ {print $2,$3}')
CLOCK=$(cat "$sclk" | grep '*' | cut -d\  -f 2)

printf '%s\n' "Vega: $CLOCK / $JUNC / $VOLT / $POWR / $FANS "
