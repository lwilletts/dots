#!/bin/sh
#
# modify VEGA20 clocks
# run as root

usage() {
    base=$(basename $0)

    cat >&2 << EOF
Usage:
    $base wine      : Set lowest powerstate to max clocks.
    $base undervolt : Set undervolt.
    $base info      : Show current clocks.
    $base fan       : Set fan speed to value [0 - 255] or auto.
    $base help      : Show this help.
EOF

    test $# -eq 0 || exit $1
}


main() {
    # change to your path
    radeonPCI="/sys/class/drm/card1/device"

    odclk="$radeonPCI/pp_od_clk_voltage"
    power="$radeonPCI/hwmon/hwmon2/power1_cap"
    fanSpeed="$radeonPCI/hwmon/hwmon2/pwm1"
    fanCtrl="$radeonPCI/hwmon/hwmon2/pwm1_enable"
    powerDRM="$radeonPCI/power_dpm_force_performance_level"

    case "$1" in
        "wine")
            printf '%s\n' "manual" > "$powerDRM"
            printf '%s\n' "300000000" > "$power"
            printf '%s\n' "s 0 1800" > "$odclk"
            printf '%s\n' "s 1 1800" > "$odclk"
            printf '%s\n' "c" > "$odclk"
            ;;
        "undervolt")
            printf '%s\n' "manual" > "$powerDRM"
            printf '%s\n' "300000000" > "$power"
            printf '%s\n' "s 0 808" > "$odclk"
            printf '%s\n' "s 1 1800" > "$odclk"
            printf '%s\n' "m 1 1200" > "$odclk"
            printf '%s\n' "vc 2 1900 1050" > "$odclk"
            printf '%s\n' "c" > "$odclk"
            ;;
        "fan")
            test -n "$2" && {
                case "$2" in
                    "auto")
                        printf '%s\n' "2" > "$fanCtrl"
                        return 0
                        ;;
                    [0-9]|1[0-9][0-9]|2[0-5][0-5])
                        fan="$2"
                        ;;
                    *)
                        fan="255"
                esac
            } || {
                fan="150"
            }

            printf '%s\n' "1" > "$fanCtrl"
            printf '%s\n' "$fan" > "$fanSpeed"
            ;;
        info)
            cat "$odclk"
            ;;
        *)
            usage
            ;;
    esac
}

main "$@"
