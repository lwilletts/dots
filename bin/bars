#!/bin/sh
#
# bars

# bar variables
barvar() {
    . fwmrc
    wmenv
    wmgaps
    wmcolours

    bar_fg="#$ACTIVE"
    bar_bg="#$INACTIVE"
    bar_dim="#808080"

    bar_border="$bar_dim"
    bar_font=$(awk '/font/ {print $3}' < ~/.Xresources | cut -d',' -f 1)
}

runbar() {
    lemonbar -d -g "${barw}x${barh}+${barx}+${bary}" -B "${bar_bg}" \
        -F "${bar_fg}" -R "${bar_border}" -r "$BW" -f "${bar_font}" -n "$1"
}

simplebar() {
    case "$1" in
        batbar|\
        datebar|\
        gpubar|\
        groupbar|\
        sysbar|\
        musbar|\
        widbar|\
        cwmbar|\
        volbaralsa|\
        volbarpulse) BAR="$1" ;;
        *)           exit     ;;
    esac

    while :; do
        buf=""

        case "$2" in
            l) buf="${buf}%{l}" ;;
            c) buf="${buf}%{c}" ;;
            r) buf="${buf}%{r}" ;;
            *) ;;
        esac

        test -z "$3" && sleepval="0.05" || sleepval="$3"
        test -z "$4" || extra="$4"

        buf="${buf}$(${BAR} $extra)"

        printf '%s\n' "$buf"
        sleep "$sleepval"
    done | runbar "$BAR" | /bin/sh &
}

musbartrigger() {
    while :; do
        process="$(ps x | awk '/lemonbar/ && /musbar/ && !/awk/ {print $1}')"

        mpvc -q
        case $? in
            2|3)
                test ! -z "$process" && kill -9 "$process"
                ;;
            0|1)
                test -z "$process" && simplebar musbar c 0 full
                ;;
        esac

        sleep 0.1
    done
}

vidbartrigger() {
    ogbarx=$((barx + barw + IGAP))

    while :; do
        process="$(ps x | awk '/lemonbar/ && /musbar/ && !/awk/ {print $1}')"

        wid -a musbar && {
            barx=$((barx + barw + IGAP))
        } || {
            barx=$((ogbarx + barw + IGAP))
        }

        mpvc -q
        case $? in
            2|3)
                test ! -z "$process" && kill -9 "$process"
                ;;
            0|1)
                test -z "$process" && simplebar vidbar c 0 full
                ;;
        esac

        sleep 0.1
    done
}

gpubartrigger() {
    while :; do
        process="$(ps x | awk '/lemonbar/ && /gpubar/ && !/awk/ {print $1}')"
        temp="$(gpu | cut -d\  -f 4 | cut -c 1-2)"

        case "$temp" in
            6[0-9]|7[0-9]|8[0-9]|9[0-9]|1[0-9])
                test -z "$process" && simplebar gpubar c 2
                ;;
            *)
                test ! -z "$process" && kill -9 "$process" > /dev/null
                ;;
        esac

        sleep 1
    done
}

mainbar() {
    BW=0
    barw=$((PW - LGAP - RGAP - BW*2))

    while :; do
        buf=""
        buf="${buf} %{l} "
        buf="${buf}$(datebar)"
        buf="${buf}$(cwmbar)"
        buf="${buf}$(notifybar)"
        buf="${buf} %{r} "
        buf="${buf}$(vidbar)"
        buf="${buf}$(musbar)"
        buf="${buf}$(batbar)"
        buf="${buf}$(${volbar})"

        printf '%s\n' "$buf"
    done | runbar "mainbar" | /bin/sh &
}

main() {
    barvar

    case "$(hostname)" in
        spark)    volbar="volbaralsa"  ;;
        fyriousa) volbar="volbarpulse" ;;
    esac

    # bar geometry
    PX="$(mattr x "$PRI")"
    PW="$(mattr w "$PRI")"
    PH="$(mattr h "$PRI")"
    SW="$(mattr w "$SEC")"
    SH="$(mattr h "$SEC")"

    barx=$((PX + LGAP + BW))
    barh=$((TGAP/2 - BW*2))
    bary=$((PY + barh - TGAP/4))
    barw=$((PW - LGAP - RGAP))

    barw=120
    simplebar datebar c 1

    barx=$((barx + barw + IGAP))
    barw=380
    musbartrigger &

    # barx=$((barx + barw + IGAP))
    # barw=380
    # vidbartrigger &

    case "$(hostname)" in
        fyriousa)
            barw=400
            barx=$((PW + LGAP))
            bary=$((SY + barh - BGAP/4))
            gpubartrigger &

            ;;
    esac
}

main "$@"
