#!/bin/sh
#
# bars

# bar variables
barvar() {
    . fwmrc
    wmenv
    wmgaps
    wmcolours
    wmgroup

    bar_fg="#$ACTIVE"
    bar_bg="#$INACTIVE"
    bar_dim="#808080"
    bar_border="$bar_dim"
    bar_active="%{F#$ACTIVE}"
    bar_inactive="%{F$bar_dim}"
    bar_font=$(awk '/font/ {print $3}' < ~/.Xresources | cut -d',' -f 1)
}

runbar() {
    lemonbar -d -g "${barw}x${barh}+${barx}+${bary}" -B "${bar_bg}" \
        -F "${bar_fg}" -R "${bar_border}" -r "$BW" -f "${bar_font}" -n "$1"
}

simplebar() {
    case "$1" in
        batbar|\
        datebar|\
        gpubar|\
        groupbar|\
        sysbar|\
        musbar|\
        volbaralsa|\
        volbarpulse) BAR="$1" ;;
        *)           exit    ;;
    esac


    while :; do
        buf=""
        case "$2" in
            l) buf="${buf}%{l}" ;;
            c) buf="${buf}%{c}" ;;
            r) buf="${buf}%{r}" ;;
            *) ;;
        esac
        buf="${buf}$(${BAR})"

        printf '%s\n' "$buf"
        sleep 0.1
    done | runbar "$BAR" | /bin/sh &
}

gpubartrigger() {
    while :; do
        process="$(ps x | awk '/lemonbar/ && /gpubar/ && !/awk/ {print $1}')"
        temp="$(gpu | cut -d\  -f 4 | cut -c 1-2)"

        case "$temp" in
            6[0-9]|7[0-9]|8[0-9]|9[0-9]|1[0-9])
                test -z "$process" && simplebar gpubar c
                ;;
            *)
                test ! -z "$process" && kill -9 "$process"
                ;;
        esac

        sleep 1
    done
}

musbartrigger() {
    while :; do
        process="$(ps x | awk '/lemonbar/ && /musbar/ && !/awk/ {print $1}')"

        mpvc -q
        case $? in
            2|3)
                test ! -z "$process" && kill -9 "$process"
                ;;
            0|1)
                test -z "$process" && simplebar musbar c
                ;;
        esac

        sleep 0.1
    done
}

groupbarinfo() {
    test -n "$(find "$groupdir" -maxdepth 1 -name '?' -print -quit)" && {
        for groupfile in "$groupdir"/?; do
            group="$(printf '%s\n' "$groupfile" | rev | cut -d/ -f 1 | rev)"

            grep -q "$group" "$activegrp" && {
                activity="$bar_active"
            } || {
                activity="$bar_inactive"
            }

            cmd="group -t $group focus"
            wid="$(head -n 1 "$groupfile")"

            case "$1" in
                text)
                    printf '%s' "$(atomx "$wid" WM_NAME)   "
                    ;;
                *)
                    printf '%s' "$bar_inactive|$bar_active$activity%{A:$cmd:} $(atomx "$wid" WM_NAME) %{A}"
                    ;;
            esac
        done
    }
}

groupbartrigger() {
    matchwid() {
        for wid in $(lsw -a); do
            printf '%s\n' "$wid $(atomx "$wid" WM_NAME)"
        done
    }

    groupbar

    sleep 0.1
    wid="$(matchwid | grep "groupbar" | grep -v grep | cut -d\  -f 1)"

    while :; do
        # dynamically resize bar to text length
        barw="$(txtw "$(groupbarinfo text)")"
        barw="$(echo "$barw * 0.78" | bc -l | cut -d. -f 1)"
        curw="$(wattr w "$wid")"

        test "$barw" -ne "$curw" && {
            wrs "$((barw - curw))" 0 "$wid"
            chwso -l "$wid"
        }

        sleep 0.1
    done
}

groupbar() {
    while :; do
        buf=""
        buf="${buf} %{l}"
        buf="${buf} $(groupbarinfo | cut -d\| -f 2-)"

        printf '%s\n' "$buf"
        sleep 0.1
    done | runbar "groupbar" | /bin/sh &
}

mainbar() {
    BW=0
    barw=$((PW - LGAP - RGAP - BW*2))

    while :; do
        buf=""
        buf="${buf} %{l} $bar_active"
        buf="${buf} $(datebar)"
        buf="${buf} $(batbar)"
        buf="${buf} %{c}"
        buf="${buf} $(groupbarinfo | cut -d\| -f 2-)"
        buf="${buf} %{r} $bar_active"
        buf="${buf} $(musbar) "
        buf="${buf} $(${volbar}) "

        printf '%s\n' "$buf"
        sleep 0.1
    done | runbar "mainbar" | /bin/sh &
}

main() {
    barvar

    SEC="$(lsm | grep -v "$PRI" | head -n 1)"


    # bar geometry
    PX="$(mattr x "$PRI")"
    PW="$(mattr w "$PRI")"
    PH="$(mattr h "$PRI")"

    test ! -z "$SEC" && {
        SH="$(mattr h "$SEC")"
    }

    barx=$((PX + LGAP + BW))
    bary=$((TGAP/4 - TGAP/8))
    barh=$((TGAP/2 + BW*2))

    case "$(hostname)" in
        spark)    volbar="volbaralsa"  ;;
        fyriousa) volbar="volbarpulse" ;;
    esac

    case "$1" in
        main)
            barw=$((PW - LGAP - RGAP))
            mainbar
            ;;
        *)
            barw=120
            simplebar datebar c

            barx=$((barx + barw + LGAP))
            barw=44
            simplebar $volbar c

            barx=$((barx + barw + LGAP))
            case "$(hostname)" in
                fyriousa)
                    prevbarx=$barx
                    prevbary=$bary
                    # barw=300
                    # barx=$((PX + PW + LGAP))
                    # bary=$((SH - BGAP + BGAP/2 - BGAP/5))
                    # gpubartrigger &
                    barx=$((prevbarx - barw - LGAP))
                    bary=$prevbary
                    barx=$((barx + barw + LGAP))
                    barw=$((PW - barx))
                    groupbartrigger &
                    ;;
                inferno)
                    barw=50
                    simplebar batbar c
                    ;;
            esac

            barw=500
            barx=$((PW - barw - RGAP))
            musbartrigger &
            ;;
    esac
}

main "$@"
