#!/bin/sh
#
# bars

# bar variables
barvar() {
    . fwmrc
    wmenv
    wmgaps
    wmcolours

    export bar_fg="#$ACTIVE"
    export bar_bg="#$INACTIVE"
    export bar_dim="#808080"

    export bar_border="$bar_dim"
    export bar_font=$(awk '/font/ {print $3}' < ~/.Xresources | cut -d',' -f 1)
}

runbar() {
    lemonbar -d -g "${barw}x${barh}+${barx}+${bary}" -B "${bar_bg}" \
             -F "${bar_fg}" -R "${bar_border}" -r "$BW" -f "${bar_font}" -n "$1"
}

simplebar() {
    case "$1" in
        batbar|\
        cwmbar|\
        gpubar|\
        mpvbar|\
        sysbar|\
        datebar|\
        volbaralsa|\
        volbarpulse) BAR="$1" ;;
        *)           exit     ;;
    esac

    test -z "$3" && sleepval="0.05" || sleepval="$3"
    test -z "$4" || name="$4"

    case "$name" in
        "/tmp/mpvsocket") BAR_NAME="musbar" ;;
        "/tmp/vidsocket") BAR_NAME="vidbar" ;;
        *)                BAR_NAME="$BAR"   ;;
    esac

    while :; do
        buf=""

        case "$2" in
            l) buf="${buf}%{l}" ;;
            c) buf="${buf}%{c}" ;;
            r) buf="${buf}%{r}" ;;
            *) ;;
        esac

        buf="${buf}$(${BAR} $name)"

        printf '%s\n' "$buf"
        sleep "$sleepval"
    done | runbar "$BAR_NAME" "$cmd1" | /bin/sh &
}

musbartrigger() {
    while :; do
        process="$(ps x | awk '/lemonbar/ && /musbar/ && !/awk/ {print $1}')"

        mpvc -q
        case $? in
            2|3)
                [ -n "$process" ] && kill -9 "$process" 2> /dev/null
                ;;
            0|1)
                [ -z "$process" ] && simplebar mpvbar c 0.01 /tmp/mpvsocket
                ;;
        esac

        sleep 0.01
    done
}

vidbartrigger() {
    ogbarx=$((barx + barw + IGAP))

    while :; do
        process="$(ps x | awk '/lemonbar/ && /vidbar/ && !/awk/ {print $1}')"

        wid -a musbar && {
            barx=$((barx + barw + IGAP))
        } || {
            barx=$((ogbarx + barw + IGAP))
        }

        mpvc -q
        case $? in
            2|3)
                [ -n "$process" ] && kill -9 "$process"
                ;;
            0|1)
                [ -z "$process" ] && simplebar mpvbar c 0.01 /tmp/vidsocket
                ;;
        esac

        sleep 0.05
    done
}

gpubartrigger() {
    while :; do
        process="$(ps x | awk '/lemonbar/ && /gpubar/ && !/awk/ {print $1}')"
        temp="$(gpu | cut -d\  -f 4 | cut -c 1-2)"

        case "$temp" in
            6[0-9]|7[0-9]|8[0-9]|9[0-9]|1[0-9])
                [ -z "$process" ] && simplebar gpubar c 3
                ;;
            *)
                [ -n "$process" ] && kill -9 "$process" > /dev/null
                ;;
        esac

        sleep 1
    done
}

mainbar() {
    BW=0
    barw=$((PW - LGAP - RGAP - BW))

    while :; do
        buf=""
        buf="${buf} %{l} "
        buf="${buf}$(datebar)"
        buf="${buf}$(notifybar)"
        buf="${buf} %{r} "
        buf="${buf}$(vidbar)"
        buf="${buf}$(musbar)"
        buf="${buf}$(batbar)"
        buf="${buf}$(${volbar})"

        printf '%s\n' "$buf"
    done | runbar "mainbar" | /bin/sh &
}

main() {
    barvar

    case "$(hostname)" in
        spark)    volbar="volbaralsa"  ;;
        fyriousa) volbar="volbarpulse" ;;
    esac

    # bar geometry
    PX="$(mattr x "$PRI")"
    PW="$(mattr w "$PRI")"
    PH="$(mattr h "$PRI")"
    SW="$(mattr w "$SEC")"
    SH="$(mattr h "$SEC")"

    barx=$((PX + LGAP))
    barw=$((PW - LGAP - RGAP))

    if [ "$BAR" = "top" ]; then
        barh=$((TGAP/2))
        bary=$((PY + barh - TGAP/4))
    else
        barh=$((BGAP/2))
        bary=$((PY + PH - barh - BGAP/4))
    fi

    case "$1" in
        -m)
            mainbar &
            ;;
        *)
            barw=120
            simplebar datebar c 3

            barx=$((barx + barw + IGAP))
            barw=380
            musbartrigger &

            # barx=$((barx + barw + IGAP))
            # barw=380
            # vidbartrigger &
            ;;
    esac

    case "$(hostname)" in
        fyriousa)
            barw=400

            if [ "$BAR" = "top" ]; then
                barx=$((PW + LGAP))
                bary=$((SY + barh - TGAP/4))
            else
                barx=$((PW + LGAP))
                bary=$((SY + SH - barh - BGAP/4))
            fi

            gpubartrigger &
            ;;
    esac
}

main "$@"
